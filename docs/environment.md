# بيئة العمل

<img src='../images/environment.png' />

من المرجح أن تطبيقك سيحتاج الكثير من البرمجيات ليعمل جيداً. فإذا لم يتطلب على الأقل حزمة إطار فلاسك، فغالباً أنت تقرأ الكتاب الخطأ. **بيئة عمل** تطبيقك هي كل الأشياء التي يحتاجها تطبيقك عندما يعمل. من حسن حظنا، يوجد عدد من الأشياء يمكننا القيام بها لجعل إدارة بيئة العمل أقل تعقيداً.

## استخدم برمجية virtualenv لإدارة بيئتك

[برمجية virtualenv](http://www.virtualenv.org/en/latest/) هي أداة تستخدم لعزل تطبيقاتك في ما يسمى **بيئة إفتراضية**. البيئة الإفتراضية هي الدليل الذي يحوي البرمجيات التي يعتمد عليها تطبيقك (إعتماديات). كما تقوم البيئة الإفتراضية بتغيير متغيرات البيئة خاصتك للحفاظ على بيئتك التطويرية مُحتواة (تحت السيطرة). فبدلاً من تنزيل الحزم أمثال فلاسك في دلائل الحزم الموجودة في فضاء النظام - أو فضاء المستخدم - يمكننا تنزيلهم في دليل معزول مُستخدم من التطبيق الحالي فقط. هذا يجعل من السهل تحديد أي إصدار بايثون ليتم إستخدامه وتحديد الإعتماديات التي نريدها لكل مشروع.

تسمح لنا هذه البرمجية أيضاً استخدام إصدارات مختلفة لنفس الحزمة لمشاريع مختلفة. هذه المرونة قد تكون مهمة إن كنت تعمل على نظام قديم بمشاريع مختلفة تملك متطلبات بإصدارات مختلفة.

عندما تستخدم هذه البرمجية، سيصبح لديك فقط بضعة حزم بايثون مثبتة على النظام ككل. إحدى هذه الحزم ستكون أداة virtualenv ذاتها. يمكنك تثبيت حزمة `virtualenv` باستخدم `pip`.

حالما تمتلك الأداة على نظامك، يمكنك البدء بإنشاء البيئات الإفتراضية. قم بالذهاب إلى دليل المشروع ونفِذ الأمر `virtualenv`. يأخذ هذا الأمر معامل واحد، والذي يمثل الدليل الهدف للبيئة الإفتراضية. المثال أدناه يُظهِر عملية إنشاء بيئة إفتراضية باستخدام هذه الأداة.

```
$ virtualenv venv
New python executable in venv/bin/python
Installing Setuptools...........[...].....done.
Installing Pip..................[...].....done.
$
```

بعد تنفيذ الأمر، ستقوم الأداة بإنشاء دليل جديد حيث سيتم تثبيت الإعتماديات.

حالما يتم إنشاء البيئة الإفتراضية، ينبغي عليك تفعيلها عن طريق استدعاء البرمجية *bin/activate* التي تم إنشائها داخل البيئة الإفتراضية.

```
$ which python
/usr/local/bin/python
$ source venv/bin/activate
(venv)$ which python
/Users/robert/Code/myapp/venv/bin/python
```

تقوم البرمجية *bin/activate* بإجراء بعض التغييرات على متغيرات الصدفة (shell) خاصتك، ليشير كل شيء (الخدمات والبرمجيات) إلى البيئة الإفتراضية خاصتك بدلاً من النظام ككل. بعد تفعيل البيئة، سيشير الأمر `python` إلى مُفسِر بايثون الموجود داخل البيئة الإفتراضية. أيضاً، الإعتماديات المثبتة باستخدام `pip` سيتم تنزيلها في البيئة الإفتراضية بدلاً من النظام.

قد تلاحظ أيضاً أن مُحث الصدفة (shell prompt) قد تغير أيضاً. وهذا لأن برمجية virtualenv تقوم بإضافة اسم البيئة الإفتراضية المُفعلة حالياً، حتى تتمكن من معرفة أنك لا تعمل على صدفة النظام.

يمكنك تعطيل البيئة الإفتراضية باستخدام الأمر `deactivate`.

```
(venv)$ deactivate
$
```

## برمجية virtualenvwrapper

تستخدم حزمة [virtualenvwrapper](http://virtualenvwrapper.readthedocs.org/en/latest/) لإدارة البيئات الإفتراضية المُنشأة باستخدام أداة virtualenv. لم أرغب بذكر هذه الأداة قبل رؤيتك لأساسيات virtualenv حتى تتمكن من فهم ما الذي تضيفه تلك الأداة ولمَ ينبغي عليك استخدامها.

البيئة الإفتراضية التي أنشأناها في المثال السابق تضيف فوضى إلى مستودع مشروعك. فأنت لا تتعامل معها سوى عندما تقوم بتفعيلها كما لا ينبغي تتبعها بنظام التحكم بالإصدارات، وبالتالي، لا داعي لوجودها في مستودع المشروع أصلاً. الحل لهذا هو استخدام أداة virtualenvwrapper. تقوم هذه الحزمة بإبقاء جميع البيئات الإفتراضية في دليل واحد، إفتراضياً في *virtualenvs./~*.

لتثبيت الأداة قم باتباع الإرشادات الموجودة في التوثيق الرسمي.

<blockquote>
<b>تحذير</b><br/>
تأكد من تعطيل كل البيئات الإفتراضية قبل تثبيت virtualenvwrapper. فأنت تريد تثبيتها في النظام وليس في البيئة الإفتراضية.
</blockquote>

والآن، قم باستخدام الأمر `mkvirtualenv` لإنشاء بيئة إفتراضية بدلاً من استخدام `virtualenv`:

```
$ mkvirtualenv rocket
New python executable in rocket/bin/python
Installing setuptools...........[...].....done.
Installing pip..................[...].....done.
(rocket)$
```

سيقوم الأمر `mkvirtualenv` بإنشاء دليل في مجلد البيئات الإفتراضية خاصتك وسيقوم بتفعيل البيئة لك. كما سابقاً، سيشير مُفسِر `python` والبرمجية `pip` إلى البيئة الإفتراضية بدلاً من النظام. لتفعيل بيئة إفتراضية معينة استخدم الأمر `[اسم البيئة] workon`. مايزال الأمر `deactivate` يُستخدم لتعطيل البيئة.

### تتبع الإعتماديات

مع نمو مشروعك، ستجد أنَّ قائمة الإعتماديات تنمو معه. فإنه ليس من غير المألوف أن تحتاج إلى عشرات الحزم لتشغيل تطبيق فلاسك. الطريقة الأسهل لإدارة هذا هو استخدام ملف نصي بسيط. تتمكن برمجية `pip` من توليد ملف نصي يسرد جميع الحزم المثبتة. كما تتمكن من قراءته أيضاً لتثبيت كل حزمة مسرودة على نظام آخر، أو في بيئة طازجة.

#### تعليمة pip freeze

يُستخدم الملف النصي *requirements.txt* من قبل العديد من تطبيقات فلاسك لسرد جميع الحزم المطلوبة لتشغيل التطبيق. المثال أدناه يشرح كيفية إنشاء هذا الملف، ويشرح المثال الذي يليه كيفية استخدام هذا الملف النصي لتثبيت الإعتماديات في بيئة جديدة.

```
(rocket)$ pip freeze > requirements.txt
```

```
$ workon fresh-env
(fresh-env)$ pip install -r requirements.txt
[...]
Successfully installed flask Werkzeug Jinja2 itsdangerous markupsafe
Cleaning up...
(fresh-env)$
```

### التتبع اليدوي للإعتماديات

مع نمو مشروعك، قد تجد بعض الحزم المدرجة بواسطة الأمر `pip freeze` ليست في الواقع ضرورية لتشغيل التطبيق. حيث سيكون لديك أيضاً الحزم المُثبتة للاستخدام في عملية التطوير فقط. الأمر `pip freeze` لا يميز بين الإثنين، فهو يقوم فقط بإدراج الحزم المُثبتة حالياً. كنتيجة لذلك، قد ترغب بتتبع إعتمادياتك يدوياً عند إضافتها. يمكنك فصل بين الحزم الضرورية لتشغيل التطبيق والحزم الضرورية للتطويره ووضعهم في الملفين *require_run.txt* و *require_dev.txt* على التوالي.

## التحكم بالإصدارات

اختر نظام تحكم بالإصدارات لاستخدامه. انصح باستخدام جيت (Git). مما رأيته، جيت هو الخيار الأكثر شعبية للمشاريع الجديدة هذه الأيام. أن تكون قادراً على حذف التعليمات البرمجية دون الحاجة إلى القلق من القيام بأخطاء لا رجعة فيها شيءٌ لا يقدر بثمن.حيث ستكون قادراً على الحفاظ على مشروعك خالياً من التعليقات، لأنه يمكنك حذف ما تريد الآن والرجوع عن التغيير إذا دعت الحاجة. إضافةً لذلك، ستملك نسخ إحتياطية لمشروعك على جيتهاب، أو Bitbucket، أو خادم Gitolite الخاص بك.

### ماذا يجب أن تبقي خارج نظام التحكم بالإصدارات

عادةً ما أبقي ملف خارج نظام التحكم بالإصدارات لسببٍ أو سببين. إما لأنه خردة (غير ضروري)، أو لأنه سري. ملفات *pyc.* والبيئات الإفتراضية - إن كنت لا تستخدم virtualenvwrapper لسببٍ ما - أمثلة على الخردة. لأنهم ليسوا بحاجة ﻷن يكونوا في نظام التحكم بالإصدارات لأنه من الممكن إعادة إنشائهم باستخدام ملفات *py.* و *requirement.txt* على التوالي.

مفاتيح الواجهات البرمجية، والمفاتيح السرية للتطبيق وبيانات اعتماد قاعدة البيانات هي أمثلة على الأسرار. لأنه لا ينبغي وجودهم في نظام التحكم بالإصدارات لأن كشفهم سيكون خرقاً أمنياً كبيراً.

<blockquote>
<b>ملاحظة</b><br/>
عندما اتخد قرارات متعلقة بالأمن، غالباً ما أفترض أن مستودعي سيصبح ظاهراً للعموم في مرحلةٍ ما. وهذا يعني الإبقاء على الأشياء السرية وعدم الافتراض أنه لن يتم العثور على ثغرة أمنية ﻷن مبدأ افتراض أن "من سيستطيع تخمين أنها تتمكن من فعل ذلك؟" معروف في المجال الأمني بالإبهام (obscurity) وهي سياسة سيئة للاعتماد عليها.
</blockquote>

عند استخدام جيت، يمكنك إنشاء ملف خاص يدعى *gitignore.* في مستودعك. في هذا الملف، قم بسرد أنماط تستخدم حروف بدل لتطابق أسماء ملفات معينة. أي ملف يتطابق مع أحد تلك الأنماط سيتم تجاهله بواسطة جيت. أنصحك باستخدام ملف *gitignore.* الموضح أدناه للتوضح الفكرة.

```
*.pyc
instance/
```

تستخدم مجلدات *instance* لجعل متغيرات الإعداد السرية متاحة لتطبيقك بطريقة أكثر أماناً. سنتحدث المزيد عنهم لاحقاً.

<blockquote>
<b>ملاحظة</b><br/>
يمكنك قراءة المزيد حول ملف <i>gitignore.</i> على <a href='http://git-scm.com/docs/gitignore'>http://git-scm.com/docs/gitignore</a>
</blockquote>

## التنقيح (تصحيح الأخطاء)

### وضع التنقيح

يأتي إطار فلاسك مع ميزة مفيدة تدعى "وضع التنقيح". لتشغيلها، عليك تعيين `debug = True` في إعدادات التطوير خاصتك. عندما يكون هذا الخيار قيد العمل، يقوم الخادم بإعادة التشغيل عن إجراء تغييرات على الشيفرة البرمجية وستظهر الأخطاء في وحدة التحكم التفاعلية (interactive console).

<blockquote>
<b>تحذير</b><br/>
انتبه من تشغيل وضع التنقيح في وضع الإنتاج. تُمكِن وحدة التحكم التفاعلية اعتباطياً من تنفيذ تعليمات برمجية مما سيؤدي إلى هشاشة أمنية كبير إذا تُرِكت هذه الخاصية قيد العمل في الموقع الحي (المرفوع على الشابكة).
</blockquote>

### أداة Flask-DebugToolbar

برمجية [Flask-DebugToolbar](http://flask-debugtoolbar.readthedocs.org/en/latest/) هي أداة رائعة أخرى لتنقيح المشاكل الموجودة في تطبيقك. في وضع التنقيح، ستقوم الأداة بإضافة شريط جانبي في كل صفحة في تطبيقك. هذا الشريط يوفِر معلومات حول استعلامات SQL، التسجيل (logging)، والإصدارات، والقوالب، والإعدادات وغيرها من الأشياء الجميلة التي ستجعل تتبع الأخطاء أسهل.

<blockquote>
<b>ملاحظة</b><br/>
<ul style='list-style-type: disc; list-style-position: inside;'>
  <li>خذ نظرة على <a href='http://flask.pocoo.org/docs/quickstart/#debug-mode'>قسم البداية السريعة مع وضع التنقيح</a>.</li>
  <li>يوجد بعض المعلومات الجيدة حول التعامل مع الأخطاء، التسجيل والعمل مع المنقحات الأخرى <a href='http://flask.pocoo.org/docs/errorhandling'>في توثيقات فلاسك</a>.</li>
</ul>
</blockquote>

## الخلاصة

<ul style='list-style-type: disc; list-style-position: inside;'>
  <li>استخدم أداة virtualenv لإبقاء إعتماديات تطبيقك في مكان واحد.</li>
  <li>استخدام أداة virtualenvwrapper لإبقاء بيئاتك الإفتراضية في مكان واحد.</li>
  <li>تتبع الإعتماديات باستخدام ملف نصي أو أكثر.</li>
  <li>استخدم نظام تحكم بالإصدارات. أنصحك باستخدم جيت.</li>
  <li>استخدام ملف gitignore. لإبقاء الفوضى والأسرار خارج نظام التحكم بالنسخ.</li>
  <li>يمنحك وضع التنقيح معلومات حول المشاكل في عملية التطوير.</li>
  <li>ستمنحك إضافة Flask-DebugToolbar المزيد من المعلومات.</li>
</ul>
